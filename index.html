<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Sales Report</title>
    <!-- Tailwind CSS v3 (includes JIT engine) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Custom scrollbar for result area (optional, for aesthetics) */
        .result-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .result-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .result-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }
        .result-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        function AutomatedSalesReport() {
          /*
            LAST CHANGE:
              1) The user enters Last Week's Sales in raw SR (e.g. 1520000 => 1,520,000), not in millions.
              2) We'll apply logic to output that value in K or Mn for the final display, respecting brand-based decimals.
              3) Added "Keeta" as a sales platform. For Maestro, it's after Jahez. For Pinzatta & MAD, it's after Jahez and before The Chefz.

            Example usage:
              If user enters 1520000 in LW sales => 1.52 Mn in output
              If user enters 800000 => 800K in output for all but Maestro's 'overall' where decimals are 0 => 800K
           */

          const [brand, setBrand] = useState('Maestro');
          const [lwSalesInput, setLwSalesInput] = useState('');
          const [rawInput, setRawInput] = useState('');
          const [result, setResult] = useState('');
          const [copySuccessMessage, setCopySuccessMessage] = useState('');


          // Function to determine status icon based on percentage change
          function getStatusIcon(percentage) {
            if (percentage > 0) {
              return 'ðŸŸ¢'; // Green circle for positive change
            } else if (percentage <= 0 && percentage >= -30) {
              return 'ðŸŸ¡'; // Yellow circle for minor negative change
            } else {
              return 'ðŸ”´'; // Red circle for significant negative change
            }
          }

          // Function to format sales values (e.g., 1500000 to 1.50 Mn, 80000 to 80.0K)
          function formatSales(value, type = 'overall') {
            const MILLION = 1_000_000;
            if (value >= MILLION) {
              const millions = value / MILLION;
              return millions.toFixed(2) + ' Mn'; // Format as millions with 2 decimal places
            } else {
              const thousands = value / 1000;
              let decimals = 1; // Default to 1 decimal place for thousands
              // Specific formatting for Maestro 'overall' sales (0 decimal places)
              if (brand.toLowerCase() === 'maestro' && type === 'overall') {
                decimals = 0;
              }
              return thousands.toFixed(decimals) + 'K'; // Format as thousands
            }
          }

          // Function to join an array of strings with commas and an ampersand for the last element
          function joinWithCommasAndAmp(arr) {
            if (!arr || arr.length === 0) return '';
            if (arr.length === 1) return arr[0];
            if (arr.length === 2) return arr.join(' & ');
            const last = arr[arr.length - 1];
            const initial = arr.slice(0, -1).join(', ');
            return `${initial} & ${last}`;
          }

          // Main function to generate the sales report
          function generateReport() {
            setCopySuccessMessage(''); // Clear any previous copy message
            try {
              // Split raw input into lines and trim whitespace
              const lines = rawInput.split('\n').map((line) => line.trim());

              // --- Parse Total Sales ---
              let totalSales = 0;
              const totalSalesLine = lines.find((line) =>
                line.toUpperCase().includes('TOTAL SALES:')
              );
              if (totalSalesLine) {
                const match = totalSalesLine.match(/TOTAL SALES:\s*([\d,.]+)/i);
                if (match) {
                  totalSales = parseFloat(match[1].replace(/,/g, '')); // Remove commas and parse
                }
              }

              // --- Parse Week-over-Week Growth ---
              let rawWeekGrowth = 0;
              let hasWeekGrowth = false;
              const growthLineIndex = lines.findIndex((line) =>
                line.toLowerCase().includes('than past week')
              );
              if (growthLineIndex !== -1) {
                hasWeekGrowth = true;
                const growthLine = lines[growthLineIndex];
                const match = growthLine.match(/([+-]?[\d.]+)%/); // Regex to find percentage
                if (match) {
                  rawWeekGrowth = parseFloat(match[1]);
                }
              }

              // --- Define Platforms to Check Based on Brand ---
              let platformsToCheck;
              if (brand === 'Maestro') {
                platformsToCheck = ['App', 'Web', 'Delivery', 'HungerStation', 'Jahez', 'Keeta'];
              } else if (brand === 'Pinzatta' || brand === 'MAD') {
                // Corrected order: Keeta after Jahez
                platformsToCheck = ['HungerStation', 'Jahez', 'Keeta', 'The Chefz', 'ToYou'];
              } else {
                platformsToCheck = []; // Should not happen with current dropdown, but good for robustness
              }

              // --- Helper Function to Parse Data for a Single Platform ---
              function parsePlatformBlock(name) {
                // Find the starting line for the platform
                const idx = lines.findIndex((line) =>
                  line.toLowerCase().startsWith(name.toLowerCase() + ':')
                );
                if (idx === -1) return null; // Platform not found

                const platform = {
                  name,
                  orders: 0,
                  sales: 0,
                  shareSales: 0,
                  weeklySalesChange: 0,
                  weeklySalesIcon: '',
                };

                // Parse orders and sales from the main platform line
                const mainLine = lines[idx];
                const mainMatch = mainLine.match(
                  /[^:]+:\s*([\d,.]+)\s*orders.*?([\d,.]+)\s*SR/i
                );
                if (mainMatch) {
                  platform.orders = parseFloat(mainMatch[1].replace(/,/g, ''));
                  platform.sales = parseFloat(mainMatch[2].replace(/,/g, ''));
                }

                // Parse sales share percentage
                // The share line can be 1 or 2 lines below the main platform line
                let shareLine = lines[idx + 2]; // Try 2 lines below first
                let shareMatchResult = null;

                if (shareLine) {
                    shareMatchResult = shareLine.match(/([\d.]+)% orders,\s*([\d.]+)% sales/i);
                }

                if (!shareMatchResult && (idx + 1 < lines.length)) { // If not found or line doesn't exist, try 1 line below
                    shareLine = lines[idx + 1];
                    if (shareLine) {
                        shareMatchResult = shareLine.match(/([\d.]+)% orders,\s*([\d.]+)% sales/i);
                    }
                }
                
                if (shareMatchResult) {
                    platform.shareSales = parseFloat(shareMatchResult[2]);
                }


                // Parse weekly sales change percentage
                let weeklyLine = '';
                // Search for the weekly change line within a few lines of the platform's main line
                for (let i = idx; i < idx + 5 && i < lines.length; i++) {
                  if (lines[i] && lines[i].includes('ðŸ“ˆ-W:')) {
                    weeklyLine = lines[i];
                    break;
                  }
                }
                if (weeklyLine) {
                  const wMatch = weeklyLine.match(/([+-][\d.]+)% sales/i);
                  if (wMatch) {
                    platform.weeklySalesChange = parseFloat(wMatch[1]);
                    platform.weeklySalesIcon = getStatusIcon(platform.weeklySalesChange);
                  }
                }
                return platform;
              }

              // Parse data for all relevant platforms
              let parsedPlatforms = platformsToCheck
                .map((p) => parsePlatformBlock(p))
                .filter(Boolean); // Remove nulls if a platform wasn't found

              // Rename "HungerStation" to "Hunger" for brevity in the report
              parsedPlatforms = parsedPlatforms.map((plat) => {
                if (plat.name.toLowerCase() === 'hungerstation') {
                  return {
                    ...plat,
                    name: 'Hunger',
                  };
                }
                return plat;
              });

              // --- Format Overall Sales and Estimated Sales ---
              const formattedOverallSales = formatSales(totalSales, 'overall');

              const lwSalesNum = parseFloat(lwSalesInput);
              let formattedLW = '';
              let formattedEst = '';
              if (!isNaN(lwSalesNum) && lwSalesNum > 0 && hasWeekGrowth) { // Ensure lwSales is valid and growth data exists
                const est = lwSalesNum * (1 + rawWeekGrowth / 100);
                formattedLW = formatSales(lwSalesNum, 'lw'); // 'lw' type for specific formatting if needed
                formattedEst = formatSales(est, 'est'); // 'est' type for specific formatting if needed
              }

              // --- Build the Output Report String ---
              let output = [];
              output.push(`[${brand}]`); // Brand name

              // Overall sales and growth
              if (hasWeekGrowth) {
                const overallIcon = getStatusIcon(rawWeekGrowth);
                const overallRounded = Math.round(Math.abs(rawWeekGrowth));
                output.push(
                  `Overall Sales ${formattedOverallSales} SR | ${overallRounded}% ${overallIcon}`
                );
              } else {
                output.push(`Overall Sales ${formattedOverallSales} SR`);
              }

              // Estimated and Last Week's sales (if available)
              if (formattedEst && formattedLW) {
                output.push(`Est sales: ${formattedEst}, LW Sales: ${formattedLW}`);
              }
              output.push(''); // Add a blank line for spacing

              // --- Platform-specific weekly changes ---
              let significantDeclines = [];
              parsedPlatforms.forEach((p) => {
                if (p.weeklySalesIcon) { // Only show if there's weekly change data
                    const absChange = Math.round(Math.abs(p.weeklySalesChange));
                    output.push(`${p.name} ${absChange}% ${p.weeklySalesIcon}`);

                    if (p.weeklySalesChange < -30) { // Track significant declines
                        significantDeclines.push(p.name);
                    }
                }
              });
              if (parsedPlatforms.some(p => p.weeklySalesIcon)) { // Add blank line only if platform changes were added
                output.push('');
              }


              // Report significant declines
              if (significantDeclines.length > 0) {
                const joined = joinWithCommasAndAmp(significantDeclines);
                output.push(`*${joined} witnessed a significant decline*`);
                output.push('');
              }

              // --- Platform sales shares ---
              const shares = parsedPlatforms
                .filter(p => p.shareSales > 0) // Only include platforms with share data
                .map((p) => {
                    const shareRounded = Math.round(p.shareSales);
                    return `${p.name} ${shareRounded}%`;
                });

              if (shares.length > 0) {
                output.push(`% of overall - ${shares.join(', ')}`);
              }

              setResult(output.join('\n')); // Join all lines for the final report
            } catch (err) {
              console.error("Error generating report:", err); // Log error to console
              setResult('Error: Could not generate report. Please check input format.\nDetails: ' + err.message);
            }
          }
          
          // Function to handle copying text to clipboard
          const handleCopy = () => {
            setCopySuccessMessage(''); // Clear previous message
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(result).then(() => {
                setCopySuccessMessage('Report copied to clipboard!');
              }).catch(err => {
                console.error('Failed to copy with navigator.clipboard:', err);
                fallbackCopy();
              });
            } else {
              fallbackCopy();
            }
            // Hide message after 3 seconds
            setTimeout(() => setCopySuccessMessage(''), 3000);
          };

          // Fallback copy method for older browsers
          const fallbackCopy = () => {
            try {
              const textArea = document.createElement('textarea');
              textArea.value = result;
              // Make the textarea non-editable and hidden
              textArea.style.position = 'fixed'; 
              textArea.style.top = '-9999px';
              textArea.style.left = '-9999px';
              textArea.style.opacity = '0'; // Further ensure it's not visible
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              setCopySuccessMessage('Report copied (fallback)!');
            } catch (copyErr) {
              console.error('Fallback copy failed:', copyErr);
              setCopySuccessMessage('Failed to copy. Please copy manually.');
            }
          };


          // --- JSX for the UI ---
          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4 sm:p-6 font-sans">
              <div className="max-w-4xl mx-auto">
                <div className="mb-8 text-center">
                  <h1 className="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Sales Report Generator</h1>
                  <p className="text-gray-600 text-sm sm:text-base">Automatically generate formatted sales reports from raw data.</p>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 sm:p-8 mb-6">
                  <h2 className="text-xl sm:text-2xl font-semibold text-gray-800 mb-6 border-b pb-3">Report Configuration</h2>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                      <label htmlFor="brand-select" className="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                      <select
                        id="brand-select"
                        className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150 ease-in-out"
                        value={brand}
                        onChange={(e) => setBrand(e.target.value)}
                      >
                        <option value="Maestro">Maestro</option>
                        <option value="Pinzatta">Pinzatta</option>
                        <option value="MAD">MAD</option>
                      </select>
                    </div>
                    
                    <div>
                      <label htmlFor="lw-sales-input" className="block text-sm font-medium text-gray-700 mb-1">
                        Last Week{"'"}s Sales (raw SR)
                      </label>
                      <input
                        id="lw-sales-input"
                        type="text" 
                        inputMode="numeric" 
                        className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150 ease-in-out"
                        placeholder="e.g., 1520000"
                        value={lwSalesInput}
                        onChange={(e) => setLwSalesInput(e.target.value.replace(/[^0-9.]/g, ''))} 
                      />
                    </div>
                  </div>

                  <div>
                    <label htmlFor="raw-input-area" className="block text-sm font-medium text-gray-700 mb-1">
                      Paste Hourly Sales Report Data
                    </label>
                    <textarea
                      id="raw-input-area"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-150 ease-in-out min-h-[250px] sm:min-h-[300px] text-sm"
                      value={rawInput}
                      onChange={(e) => setRawInput(e.target.value)}
                      placeholder="Paste the raw report data here. Example:&#10;TOTAL SALES: 1,234,567.89&#10;...&#10;This week is 5.5% higher than past week&#10;...&#10;App: 100 orders / 10,000.00 SR&#10;10% orders, 15% sales&#10;ðŸ“ˆ-W: +5.0% sales&#10;..."
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Ensure input includes 'TOTAL SALES:', optionally 'than past week' for growth, and platform data like `App: 1,234 orders / 56,789.00 SR`.
                    </p>
                  </div>

                  <div className="mt-8 flex justify-center">
                    <button
                      onClick={generateReport}
                      className="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-all shadow-md hover:shadow-lg active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                    >
                      Generate Report
                    </button>
                  </div>
                </div>

                {result && (
                  <div className="bg-white rounded-xl shadow-lg p-6 sm:p-8">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                      <h2 className="text-xl sm:text-2xl font-semibold text-gray-800 mb-2 sm:mb-0">Generated Report</h2>
                      <div className="relative">
                        <button 
                          onClick={handleCopy}
                          className="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-md transition-colors duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300"
                        >
                          Copy Report
                        </button>
                        {copySuccessMessage && (
                          <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1.5 text-xs font-medium text-white bg-green-500 rounded-md shadow-lg whitespace-nowrap z-10">
                            {copySuccessMessage}
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 max-h-[400px] overflow-y-auto result-scrollbar">
                      <pre className="whitespace-pre-wrap font-mono text-sm text-gray-800">{result}</pre>
                    </div>
                  </div>
                )}
                <footer className="text-center mt-10 pb-6">
                    <p className="text-xs text-gray-500">Sales Report Generator v1.2.1</p>
                </footer>
              </div>
            </div>
          );
        }

        ReactDOM.render(
          <AutomatedSalesReport />,
          document.getElementById('root')
        );
    </script>
</body>
</html>
